<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Referral Race — Group Arena</title>
<meta name="theme-color" content="#121125" />
<style>
  :root{
    --bg:#0f1129; --card:#121125; --ring:#2a2e58; --ink:#f2f3ff; --mut:#c7cbff;
    --g1:#ff6ec4; --g2:#7873f5; --a3:#78f3ff; --ok:#aef7c1; --warn:#ffd86a; --bad:#ff9bb3;
    --shadow: 0 20px 60px rgba(0,0,0,.45); --radius:18px; --pad:16px; --row:64px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink); font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
    background:
      radial-gradient(1100px 700px at 85% -20%, rgba(120,115,245,.25), rgba(15,17,41,0) 60%),
      radial-gradient(900px 600px at 10% 110%, rgba(255,110,196,.20), rgba(15,17,41,0) 55%),
      linear-gradient(180deg, #0a0c1f 0%, #0e1027 100%);
    overflow-x:hidden;
  }
  header{position:sticky;top:0;z-index:20;backdrop-filter: blur(12px);
    background:linear-gradient(180deg, rgba(18,18,37,.92), rgba(18,18,37,.72)); border-bottom:1px solid var(--ring)}
  .bar{max-width:1240px;margin:0 auto;padding:14px clamp(12px,3vw,28px);display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center}
  h1{margin:0;font-size:clamp(18px,3.2vw,32px);letter-spacing:.3px}
  .grad{background:linear-gradient(90deg,var(--g1),var(--g2));-webkit-background-clip:text;background-clip:text;color:transparent}
  .btn{appearance:none;border:1px solid var(--ring);background:#1b1e3a;color:var(--ink);border-radius:14px;padding:10px 14px;font-weight:700;display:inline-flex;gap:8px;align-items:center;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--g1),var(--g2));border-color:transparent}

  .wrap{max-width:1240px;margin:0 auto;padding:18px clamp(12px,3vw,28px) 90px}

  /* ====== STEP MODALS ====== */
  dialog{border:1px solid var(--ring);background:linear-gradient(180deg,#16183a,#12122a);color:var(--ink);border-radius:20px;box-shadow:var(--shadow);padding:0;width:min(920px,94vw)}
  dialog::backdrop{background:rgba(0,0,20,.65)}
  .dlg-head{padding:16px;border-bottom:1px solid #2a2e58}
  .dlg-body{padding:16px}
  .grid-groups{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .gcard{position:relative;border:1px solid var(--ring);background:linear-gradient(180deg,#181b3e,#12122b);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
  .gtitle{display:flex;align-items:center;gap:10px;font-weight:900}
  .cap{font-size:12px;color:#b7c3ff}
  .bar{height:10px;border-radius:10px;background:#0d0f23;border:1px solid var(--ring);overflow:hidden;margin-top:10px}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--g1),var(--g2))}
  .gmeta{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
  .tag{font-size:11px;padding:4px 8px;border-radius:999px;background:#181b3c;border:1px solid #2d3160;color:#a9b7d8}
  .gbtn{margin-left:auto}

  .field{display:grid;gap:8px;margin:8px 0}
  input[type="text"],select{height:48px;border-radius:14px;background:#13142b;border:1px solid #262a52;color:var(--ink);padding:0 14px}

  /* ====== DASH ====== */
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 14px}
  .tab{height:48px;padding:0 16px;border-radius:14px;background:#161636;border:1px solid #2a2e58;display:inline-flex;align-items:center;gap:10px;cursor:pointer}
  .tab.active{background:linear-gradient(90deg, rgba(255,110,196,.22), rgba(120,115,245,.22)); box-shadow: inset 0 0 0 1px rgba(255,255,255,.08) }

  .grid-2{display:grid;grid-template-columns:1.35fr .65fr;gap:16px}
  @media (max-width:980px){ .grid-2{grid-template-columns:1fr} }
  .card{background:linear-gradient(180deg,#16183a,#12122a);border:1px solid var(--ring);border-radius:18px;padding:var(--pad);box-shadow:var(--shadow)}
  .board{margin-top:10px;border-radius:18px;overflow:hidden;border:1px solid #262a52}
  .thead,.row{display:grid;grid-template-columns:64px 1fr .8fr .8fr;align-items:center}
  .thead{height:52px;color:#9fb0d9;text-transform:uppercase;font-size:12px;letter-spacing:.4px;background:#15173a}
  .row{height:var(--row);padding:0 12px;background:linear-gradient(180deg,#0f1129,#101233);border-top:1px solid #1a1e45}
  .row:nth-child(odd){background:linear-gradient(180deg,#101233,#0f1129)}
  .pos{font-weight:900;font-size:18px}
  .user{display:flex;align-items:center;gap:12px}
  .mini{width:40px;height:40px;border-radius:50%;border:2px solid #303767;background:#222645}
  .pts{font-weight:900;font-size:18px}

  .rewards{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .reward{position:relative;padding:14px;border-radius:16px;background:linear-gradient(180deg,#181b3e,#12122b);border:1px solid var(--ring)}
  .progress{height:10px;border-radius:10px;background:#0d0f23;border:1px solid var(--ring);overflow:hidden}
  .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--g1),var(--g2))}
  .capr{position:absolute;right:12px;top:12px;font-size:12px;color:#b7c3ff}

  .groupsGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
  .groupCard{position:relative;border:1px solid var(--ring);background:linear-gradient(180deg,#181b3e,#12122b);border-radius:16px;padding:14px}
  .level{position:absolute;right:12px;top:12px;font-weight:900;background:#111436;border:1px solid #2a2e58;padding:4px 10px;border-radius:999px}
  .tiny{font-size:12px;color:#9fb0d9}

  .chip{position:fixed;right:14px;bottom:14px;background:#12122a;border:1px solid #2a2e58;border-radius:16px;padding:10px 14px;display:flex;gap:10px;align-items:center;box-shadow:var(--shadow)}
  .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(180deg,#ffd86a,#a96b03)}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div>
      <div style="font-size:12px;color:#9fb0d9">Referral Race</div>
      <h1><span class="grad">Group Arena — Pick Your Squad</span></h1>
    </div>
    <button class="btn" id="copyBtn">🔗 Copy Referral Link</button>
    <button class="btn primary" id="timerBtn">Ends in 00:00:00</button>
  </div>
</header>

<div class="wrap">
  <!-- DASH TABS -->
  <div class="tabs" role="tablist">
    <button class="tab active" data-tab="overview">🗺️ Overview</button>
    <button class="tab" data-tab="global">🌐 Global Leaderboard</button>
    <button class="tab" data-tab="mygroup">👥 My Group</button>
    <button class="tab" data-tab="rewards">🎁 Rewards</button>
  </div>

  <!-- OVERVIEW -->
  <section class="card" id="view-overview">
    <h3 style="margin:0 0 8px">Choose a Group</h3>
    <p style="margin:0 0 12px;color:var(--mut)">Each group holds up to <b>100 players</b>. Your personal ranking is global; your team also competes for group rewards.</p>
    <div class="groupsGrid" id="groupsGrid"></div>
  </section>

  <!-- GLOBAL + GROUP PANELS -->
  <section class="grid-2" id="view-boards" style="display:none">
    <div class="card">
      <h3 style="margin:0">Global Leaderboard</h3>
      <div class="board">
        <div class="thead"><div>#</div><div>Player</div><div>Referrals</div><div>Points</div></div>
        <div id="globalRows"></div>
      </div>
    </div>
    <aside class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">My Group</h3>
        <div class="tiny" id="groupMeta"></div>
      </div>
      <div class="board" style="margin-top:8px">
        <div class="thead"><div>#</div><div>Player</div><div>Referrals</div><div>Points</div></div>
        <div id="groupRows"></div>
      </div>
    </aside>
  </section>

  <!-- REWARDS -->
  <section class="grid-2" id="view-rewards" style="display:none">
    <div class="card">
      <h3 style="margin:0 0 8px">Personal Rewards (Global)</h3>
      <p style="margin:0 0 12px;color:var(--mut)">Based on your <b>global points</b> across all groups.</p>
      <div class="rewards" id="personalRewards"></div>
    </div>
    <aside class="card">
      <h3 style="margin:0 0 8px">Group Rewards</h3>
      <p style="margin:0 0 12px;color:var(--mut)">Based on your <b>group total points</b> vs levels.</p>
      <div class="rewards" id="teamRewards"></div>
    </aside>
  </section>
</div>

<!-- Floating chip -->
<div class="chip" id="meChip" aria-live="polite" style="display:none">
  <span class="dot"></span>
  <span><b id="meRank">#—</b> • <span id="mePts">0 pts</span> • <span id="meGroup">Group ?</span></span>
</div>

<!-- DIALOGS -->
<dialog id="dlgGroups">
  <div class="dlg-head"><b>Select a Group (Max 100 per group)</b></div>
  <div class="dlg-body">
    <div class="grid-groups" id="dlgGroupList"></div>
  </div>
</dialog>

<dialog id="dlgJoin">
  <div class="dlg-head"><b>Join Group</b></div>
  <div class="dlg-body">
    <div class="field">
      <label for="username">Username (public)</label>
      <input id="username" type="text" maxlength="24" placeholder="Enter your username"/>
    </div>
    <div class="field">
      <label for="groupPick">Group</label>
      <select id="groupPick"></select>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button class="btn" id="cancelJoin">Cancel</button>
      <button class="btn primary" id="confirmJoin">Join</button>
    </div>
  </div>
</dialog>

<script>
/**************** CONFIG + DEMO DB ****************/
const GROUPS = [
  { id:'alpha',  name:'Alpha',   emoji:'🅰️', color:'#8e8cff' },
  { id:'bravo',  name:'Bravo',   emoji:'🅱️', color:'#ff8cbd' },
  { id:'cosmo',  name:'Cosmo',   emoji:'🪐', color:'#78f3ff' },
  { id:'delta',  name:'Delta',   emoji:'🔺', color:'#ffd86a' },
  { id:'ember',  name:'Ember',   emoji:'🔥', color:'#ff9b7a' },
];
const GROUP_CAP = 100;
const PERSONAL_TIERS = [
  {need:500, reward:'10 Free Spins'},
  {need:1500, reward:'1 Lucky Sweet Spin'},
  {need:3000, reward:'30 Free Spins'},
  {need:6000, reward:'VIP Mystery Box'},
];
const GROUP_LEVELS = [
  {need: 20000, label:'Level 1', reward:'All members: 5 FS'},
  {need: 60000, label:'Level 2', reward:'All members: 1 Sweet Spin'},
  {need:120000, label:'Level 3', reward:'All members: 20 FS'},
  {need:240000, label:'Level 4', reward:'All members: VIP Box'},
];

// Simulated DB
let DB = {
  players: [], // {id, name, groupId, points, referrals, avatar}
};

/********** SEED DATA (demo) **********/
function randName(){
  const names = 'Nova,Ace,Rio,Mika,Sol,Jet,Skye,Zee,Luna,Max,Axel,Zara,Milo,Kai,Noah,Ava,Theo,Lex,Juno,Nyx'.split(',');
  const n = names[Math.floor(Math.random()*names.length)];
  return n + (Math.random()<.5? ''+Math.floor(Math.random()*90):'');
}
function seedPlayers(){
  DB.players = [];
  GROUPS.forEach(g=>{
    const count = Math.floor(40 + Math.random()*40); // 40-80 members
    for(let i=0;i<count;i++){
      const name = randName();
      const refs = Math.floor(Math.random()*120);
      const pts = refs*100 + Math.floor(Math.random()*600);
      DB.players.push({
        id: g.id + '-' + (1000+i),
        name,
        groupId: g.id,
        points: pts,
        referrals: refs,
        avatar: `https://api.dicebear.com/7.x/pixel-art/svg?seed=${encodeURIComponent(name)}`,
      });
    }
  });
}
seedPlayers();

/********** STATE **********/
let me = JSON.parse(localStorage.getItem('rr_me')||'null'); // {id, name, groupId}

/********** UTIL **********/
const $ = s=>document.querySelector(s);
function fmt(n){return (n||0).toLocaleString();}
function groupStats(gid){
  const members = DB.players.filter(p=>p.groupId===gid);
  const total = members.reduce((a,b)=>a+b.points,0);
  const refs = members.reduce((a,b)=>a+b.referrals,0);
  return {members: members.length, total, refs};
}
function groupLevel(total){
  let lvl = 0; for(const [i,l] of GROUP_LEVELS.entries()){ if(total>=l.need) lvl=i+1; }
  return lvl;
}

/********** HEADER TIMER **********/
const END = new Date(Date.now() + 1000*60*60*24*4 + 1000*60*30);
function tickTimer(){
  const d = END - Date.now(); if(d<=0){ $('#timerBtn').textContent='Race finished'; return }
  const h=Math.floor(d/3.6e6), m=Math.floor((d%3.6e6)/6e4), s=Math.floor((d%6e4)/1e3);
  $('#timerBtn').textContent = `Ends in ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
setInterval(tickTimer,1000); tickTimer();

/********** GROUP CARDS (Overview) **********/
function renderGroups(){
  const box = $('#groupsGrid'); box.innerHTML='';
  GROUPS.forEach(g=>{
    const {members,total,refs} = groupStats(g.id);
    const capPct = Math.round((members/GROUP_CAP)*100);
    const lvl = groupLevel(total);
    const card = document.createElement('article');
    card.className='groupCard';
    card.innerHTML = `
      <div class="level">LV ${lvl}</div>
      <div class="gtitle" style="gap:10px">
        <span style="font-size:22px">${g.emoji}</span>
        <div>
          <div style="font-weight:900">${g.name}</div>
          <div class="tiny">${fmt(members)}/${GROUP_CAP} players • ${fmt(refs)} refs</div>
        </div>
      </div>
      <div style="margin-top:10px" class="tiny">Team points</div>
      <div class="bar" title="${fmt(total)} pts"><i style="width:${Math.min(100,(total/GROUP_LEVELS.at(-1).need)*100)}%"></i></div>
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:10px">
        <span class="tag">${fmt(total)} pts</span>
        <button class="btn" data-join="${g.id}" ${members>=GROUP_CAP? 'disabled':''}>${members>=GROUP_CAP?'Full':'Join'}</button>
      </div>
    `;
    box.appendChild(card);
  });
}

/********** DIALOG LOGIC **********/
const dlgGroups = $('#dlgGroups');
const dlgJoin = $('#dlgJoin');
function openJoinDialog(defaultGroup){
  // Fill options
  const sel = $('#groupPick'); sel.innerHTML='';
  GROUPS.forEach(g=>{
    const m = groupStats(g.id).members; if(m>=GROUP_CAP && g.id!==defaultGroup) return;
    const opt = document.createElement('option'); opt.value=g.id; opt.textContent = `${g.name} (${m}/${GROUP_CAP})`;
    if(g.id===defaultGroup) opt.selected=true;
    sel.appendChild(opt);
  });
  $('#username').value = me?.name || '';
  dlgJoin.showModal();
}

// Overview join buttons
addEventListener('click', (e)=>{
  const t = e.target.closest('[data-join]'); if(!t) return;
  if(me){ alert('You have already joined: '+me.groupId); return; }
  openJoinDialog(t.dataset.join);
});

$('#cancelJoin').addEventListener('click', ()=> dlgJoin.close());
$('#confirmJoin').addEventListener('click', ()=>{
  const name = ($('#username').value||'').trim();
  const gid = $('#groupPick').value;
  if(!name || name.length<2){ alert('Please enter a valid username (min 2 chars).'); return; }
  const exists = DB.players.some(p=>p.name.toLowerCase()===name.toLowerCase());
  if(exists){ if(!confirm('This username exists. Use anyway?')) return; }
  const m = groupStats(gid).members; if(m>=GROUP_CAP){ alert('Group is full. Pick another.'); return; }
  // create player
  const id = 'you';
  const avatar = `https://api.dicebear.com/7.x/pixel-art/svg?seed=${encodeURIComponent(name)}`;
  DB.players.push({ id, name, groupId: gid, points: 0, referrals: 0, avatar });
  me = { id, name, groupId: gid };
  localStorage.setItem('rr_me', JSON.stringify(me));
  dlgJoin.close();
  afterJoin();
});

/********** POST-JOIN DASH **********/
function renderLeaderboards(){
  // global
  const gl = [...DB.players].sort((a,b)=>b.points-a.points).slice(0,50);
  const gRows = $('#globalRows'); gRows.innerHTML='';
  gl.forEach((p,i)=>{
    const el = document.createElement('div'); el.className='row'; if(me && p.id===me.id) el.style.background='linear-gradient(90deg, rgba(255,110,196,.10), rgba(120,115,245,.10))';
    el.innerHTML = `<div class="pos">${i+1}</div>
      <div class="user"><img class="mini" src="${p.avatar}"><div><b>${p.name}</b><div style="font-size:11px;opacity:.8">ID: ${p.id}</div></div></div>
      <div class="pts">${fmt(p.referrals)}</div>
      <div class="pts">${fmt(p.points)}</div>`;
    gRows.appendChild(el);
  });

  // group
  if(me){
    const my = DB.players.filter(p=>p.groupId===me.groupId).sort((a,b)=>b.points-a.points);
    const box = $('#groupRows'); box.innerHTML='';
    my.forEach((p,i)=>{
      const el = document.createElement('div'); el.className='row'; if(p.id===me.id) el.style.background='linear-gradient(90deg, rgba(255,110,196,.10), rgba(120,115,245,.10))';
      el.innerHTML = `<div class="pos">${i+1}</div>
        <div class="user"><img class="mini" src="${p.avatar}"><div><b>${p.name}</b><div style="font-size:11px;opacity:.8">ID: ${p.id}</div></div></div>
        <div class="pts">${fmt(p.referrals)}</div>
        <div class="pts">${fmt(p.points)}</div>`;
      box.appendChild(el);
    });

    const gs = groupStats(me.groupId);
    $('#groupMeta').textContent = `${gs.members}/${GROUP_CAP} players • ${fmt(gs.total)} pts • ${fmt(gs.refs)} refs`;
  }
}

function renderRewards(){
  if(!me) return;
  const mine = DB.players.find(p=>p.id===me.id);
  // Personal
  const pBox = $('#personalRewards'); pBox.innerHTML='';
  PERSONAL_TIERS.forEach(t=>{
    const pct = Math.max(0, Math.min(100, Math.round((mine.points/t.need)*100)));
    const card = document.createElement('div'); card.className='reward';
    card.innerHTML = `<div class="capr">Need: ${fmt(t.need)}</div>
      <h4 style="margin:0 0 8px">${t.reward}</h4>
      <div class="progress"><i style="width:${pct}%"></i></div>
      <p style="margin:8px 0 0;color:var(--mut)">${fmt(mine.points)} / ${fmt(t.need)} pts</p>`;
    pBox.appendChild(card);
  });

  // Group
  const gBox = $('#teamRewards'); gBox.innerHTML='';
  const gs = groupStats(me.groupId);
  GROUP_LEVELS.forEach(l=>{
    const pct = Math.max(0, Math.min(100, Math.round((gs.total/l.need)*100)));
    const card = document.createElement('div'); card.className='reward';
    card.innerHTML = `<div class="capr">Target: ${fmt(l.need)}</div>
      <h4 style="margin:0 0 8px">${l.label} — ${l.reward}</h4>
      <div class="progress"><i style="width:${pct}%"></i></div>
      <p style="margin:8px 0 0;color:var(--mut)">${fmt(gs.total)} / ${fmt(l.need)} pts</p>`;
    gBox.appendChild(card);
  });
}

function afterJoin(){
  renderGroups();
  renderLeaderboards();
  renderRewards();
  if(me){
    $('#view-overview').style.display='none';
    $('#view-boards').style.display='grid';
    $('#view-rewards').style.display='grid';
    $('#meChip').style.display='flex';
    const mine = DB.players.find(p=>p.id===me.id);
    const gl = [...DB.players].sort((a,b)=>b.points-a.points);
    $('#meRank').textContent = '#' + (gl.findIndex(p=>p.id===me.id)+1);
    $('#mePts').textContent = fmt(mine.points) + ' pts';
    $('#meGroup').textContent = 'Group ' + me.groupId;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelector('[data-tab="global"]').classList.add('active');
    showTab('global');
  }
}

/********** TABS **********/
function showTab(key){
  $('#view-overview').style.display = key==='overview' ? 'block':'none';
  $('#view-boards').style.display   = (key==='global'||key==='mygroup') ? 'grid':'none';
  $('#view-rewards').style.display  = key==='rewards' ? 'grid':'none';
}
for(const t of document.querySelectorAll('.tab')){
  t.addEventListener('click', ()=>{
    document.querySelector('.tab.active')?.classList.remove('active');
    t.classList.add('active');
    showTab(t.dataset.tab);
  });
}

/********** COPY LINK **********/
const REF_LINK = (location.origin||'https://your-domain') + '/?ref=VIP123';
$('#copyBtn').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(REF_LINK); }catch(e){ const ta=document.createElement('textarea'); ta.value=REF_LINK; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
  const b=$('#copyBtn'); b.textContent='✅ Copied!'; setTimeout(()=>b.textContent='🔗 Copy Referral Link',1200);
});

/********** LIVE DEMO UPDATES **********/
setInterval(()=>{
  // Random player earns points/ref
  const i = Math.floor(Math.random()*DB.players.length); const p = DB.players[i];
  const gain = 60 + Math.floor(Math.random()*140); p.points += gain; p.referrals += Math.random()<.4 ? 1 : 0;
  // Repaint if dashboards visible
  renderGroups();
  if(me){ renderLeaderboards(); renderRewards(); }
}, 3200);

/********** INIT **********/
renderGroups();
if(!me){
  // Encourage selection by opening dialog (optional)
  // $('#dlgGroups').showModal(); // keep closed by default; overview shows cards already
}else{
  // Ensure the stored player exists (for demo) or re-create
  const have = DB.players.find(p=>p.id===me.id);
  if(!have){
    DB.players.push({ id: me.id, name: me.name, groupId: me.groupId, points: 0, referrals: 0, avatar:`https://api.dicebear.com/7.x/pixel-art/svg?seed=${encodeURIComponent(me.name)}` });
  }
  afterJoin();
}
</script>
</body>
</html>
